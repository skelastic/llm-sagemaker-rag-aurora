{
 "Resources": {
  "SageMakerExecutionRole7843F3B8": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": [
         "codebuild.amazonaws.com",
         "sagemaker.amazonaws.com"
        ]
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "ManagedPolicyArns": [
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/AmazonSageMakerFullAccess"
       ]
      ]
     },
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/AmazonSageMakerCanvasFullAccess"
       ]
      ]
     },
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/AWSCloudFormationReadOnlyAccess"
       ]
      ]
     },
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/AmazonRDSReadOnlyAccess"
       ]
      ]
     }
    ],
    "Path": "/",
    "Policies": [
     {
      "PolicyDocument": {
       "Statement": [
        {
         "Action": [
          "s3:DeleteObject",
          "s3:GetObject",
          "s3:ListBucket",
          "s3:PutObject"
         ],
         "Effect": "Allow",
         "Resource": "arn:aws:s3:::*"
        }
       ],
       "Version": "2012-10-17"
      },
      "PolicyName": "sagemaker-execution-policy"
     },
     {
      "PolicyDocument": {
       "Statement": [
        {
         "Action": "secretsmanager:GetSecretValue",
         "Effect": "Allow",
         "Resource": {
          "Fn::Join": [
           "",
           [
            "arn:aws:secretsmanager:",
            {
             "Ref": "AWS::Region"
            },
            ":",
            {
             "Ref": "AWS::AccountId"
            },
            ":secret:*"
           ]
          ]
         }
        }
       ],
       "Version": "2012-10-17"
      },
      "PolicyName": "sagemaker-custom-access-policy"
     },
     {
      "PolicyDocument": {
       "Statement": [
        {
         "Action": [
          "ec2:DescribeAvailabilityZones",
          "ecr:BatchCheckLayerAvailability",
          "ecr:BatchGetImage",
          "ecr:CompleteLayerUpload",
          "ecr:CreateRepository",
          "ecr:DescribeImages",
          "ecr:DescribeRepositories",
          "ecr:GetAuthorizationToken",
          "ecr:GetDownloadUrlForLayer",
          "ecr:InitiateLayerUpload",
          "ecr:ListImages",
          "ecr:PutImage",
          "ecr:UploadLayerPart",
          "iam:GetRole",
          "iam:ListRoles",
          "logs:CreateLogGroup"
         ],
         "Effect": "Allow",
         "Resource": "*"
        },
        {
         "Action": [
          "codebuild:BatchGetBuilds",
          "codebuild:CreateProject",
          "codebuild:DeleteProject",
          "codebuild:StartBuild"
         ],
         "Effect": "Allow",
         "Resource": "arn:aws:codebuild:*:*:project/sagemaker-studio*"
        },
        {
         "Action": "logs:CreateLogStream",
         "Effect": "Allow",
         "Resource": "arn:aws:logs:*:*:log-group:/aws/codebuild/sagemaker-studio*"
        },
        {
         "Action": [
          "logs:GetLogEvents",
          "logs:PutLogEvents"
         ],
         "Effect": "Allow",
         "Resource": "arn:aws:logs:*:*:log-group:/aws/codebuild/sagemaker-studio*:log-stream:*"
        },
        {
         "Action": [
          "s3:DeleteObject",
          "s3:GetObject",
          "s3:PutObject"
         ],
         "Effect": "Allow",
         "Resource": "arn:aws:s3:::sagemaker-*/*"
        },
        {
         "Action": "s3:CreateBucket",
         "Effect": "Allow",
         "Resource": "arn:aws:s3:::sagemaker*"
        },
        {
         "Action": "iam:PassRole",
         "Condition": {
          "StringLikeIfExists": {
           "iam:PassedToService": [
            "codebuild.amazonaws.com"
           ]
          }
         },
         "Effect": "Allow",
         "Resource": "arn:aws:iam::*:role/*"
        }
       ],
       "Version": "2012-10-17"
      },
      "PolicyName": "sagemaker-docker-build-policy"
     }
    ],
    "RoleName": "AmazonSageMakerStudioExecutionRole-34435"
   },
   "Metadata": {
    "aws:cdk:path": "RAGSageMakerStudioStack/SageMakerExecutionRole/Resource"
   }
  },
  "SageMakerDomainSG31453CAE": {
   "Type": "AWS::EC2::SecurityGroup",
   "Properties": {
    "GroupDescription": "security group for sagmaker studio domain",
    "GroupName": "sagemaker-domain-sg",
    "SecurityGroupEgress": [
     {
      "CidrIp": "0.0.0.0/0",
      "Description": "Allow all outbound traffic by default",
      "IpProtocol": "-1"
     }
    ],
    "SecurityGroupIngress": [
     {
      "CidrIp": "0.0.0.0/0",
      "Description": "https",
      "FromPort": 443,
      "IpProtocol": "tcp",
      "ToPort": 443
     }
    ],
    "Tags": [
     {
      "Key": "Name",
      "Value": "sagemaker-domain-sg"
     }
    ],
    "VpcId": {
     "Fn::ImportValue": "RAGVpcStack:ExportsOutputRefRAGAppVPC19F11A0EF8DC0A5C"
    }
   },
   "Metadata": {
    "aws:cdk:path": "RAGSageMakerStudioStack/SageMakerDomainSG/Resource"
   }
  },
  "SageMakerDomainSGfromRAGSageMakerStudioStackSageMakerDomainSGE8AB2FAAALLPORTSC8F7FCD2": {
   "Type": "AWS::EC2::SecurityGroupIngress",
   "Properties": {
    "Description": "All traffic within the sagemaker domain security group",
    "FromPort": 0,
    "GroupId": {
     "Fn::GetAtt": [
      "SageMakerDomainSG31453CAE",
      "GroupId"
     ]
    },
    "IpProtocol": "tcp",
    "SourceSecurityGroupId": {
     "Fn::GetAtt": [
      "SageMakerDomainSG31453CAE",
      "GroupId"
     ]
    },
    "ToPort": 65535
   },
   "Metadata": {
    "aws:cdk:path": "RAGSageMakerStudioStack/SageMakerDomainSG/from RAGSageMakerStudioStackSageMakerDomainSGE8AB2FAA:ALL PORTS"
   }
  },
  "SageMakerStudioDomain": {
   "Type": "AWS::SageMaker::Domain",
   "Properties": {
    "AppNetworkAccessType": "VpcOnly",
    "AuthMode": "IAM",
    "DefaultUserSettings": {
     "ExecutionRole": {
      "Fn::GetAtt": [
       "SageMakerExecutionRole7843F3B8",
       "Arn"
      ]
     }
    },
    "DomainName": "llm-sagemaker-rag-aurora",
    "DomainSettings": {
     "SecurityGroupIds": [
      {
       "Fn::GetAtt": [
        "SageMakerDomainSG31453CAE",
        "GroupId"
       ]
      }
     ]
    },
    "SubnetIds": [
     {
      "Fn::ImportValue": "RAGVpcStack:ExportsOutputRefRAGAppVPCPrivateSubnet1SubnetAEDC78DA0859FA39"
     },
     {
      "Fn::ImportValue": "RAGVpcStack:ExportsOutputRefRAGAppVPCPrivateSubnet2SubnetB9256C5AC0B42312"
     },
     {
      "Fn::ImportValue": "RAGVpcStack:ExportsOutputRefRAGAppVPCPrivateSubnet3Subnet63066A5C3CBE8053"
     }
    ],
    "VpcId": {
     "Fn::ImportValue": "RAGVpcStack:ExportsOutputRefRAGAppVPC19F11A0EF8DC0A5C"
    }
   },
   "Metadata": {
    "aws:cdk:path": "RAGSageMakerStudioStack/SageMakerStudioDomain"
   }
  },
  "SageMakerStudioUserProfile": {
   "Type": "AWS::SageMaker::UserProfile",
   "Properties": {
    "DomainId": {
     "Fn::GetAtt": [
      "SageMakerStudioDomain",
      "DomainId"
     ]
    },
    "UserProfileName": "default-user",
    "UserSettings": {
     "JupyterServerAppSettings": {
      "DefaultResourceSpec": {
       "InstanceType": "system"
      }
     },
     "SecurityGroups": [
      {
       "Fn::GetAtt": [
        "SageMakerDomainSG31453CAE",
        "GroupId"
       ]
      },
      {
       "Fn::ImportValue": "RAGPgVectorStack:ExportsOutputFnGetAttPostgreSQLClientSG1CB4CECFGroupId5D24BDFF"
      }
     ]
    }
   },
   "Metadata": {
    "aws:cdk:path": "RAGSageMakerStudioStack/SageMakerStudioUserProfile"
   }
  },
  "CDKMetadata": {
   "Type": "AWS::CDK::Metadata",
   "Properties": {
    "Analytics": "v2:deflate64:H4sIAAAAAAAA/32NwQ6CMBAFv4V7WRUPctfEeJJgPJtaF1yhLdm2MaTpvwvo2dNL5k0yBZQlrDP5drl6dHlPd4gXL1UnJnSLJDXE2vYo9o2ZNwlUxaSgCkx+PLINw/z9ByfTMjqXhJMtatkhQ5ycg9WSzGxfHXLFtqGpkESNzgZWS/Qc/BD8kv/RJKrRP61ZbWGzgV32ckQ5B+NJI9Tf/QDHpSPt1wAAAA=="
   },
   "Metadata": {
    "aws:cdk:path": "RAGSageMakerStudioStack/CDKMetadata/Default"
   }
  }
 },
 "Outputs": {
  "DomainUrl": {
   "Value": {
    "Fn::GetAtt": [
     "SageMakerStudioDomain",
     "Url"
    ]
   },
   "Export": {
    "Name": "RAGSageMakerStudioStack-DomainUrl"
   }
  },
  "DomainId": {
   "Value": {
    "Fn::GetAtt": [
     "SageMakerStudioDomain",
     "DomainId"
    ]
   },
   "Export": {
    "Name": "RAGSageMakerStudioStack-DomainId"
   }
  },
  "UserProfileName": {
   "Value": "default-user",
   "Export": {
    "Name": "RAGSageMakerStudioStack-UserProfileName"
   }
  },
  "SecurityGroupId": {
   "Value": {
    "Fn::GetAtt": [
     "SageMakerDomainSG31453CAE",
     "GroupId"
    ]
   },
   "Export": {
    "Name": "RAGSageMakerStudioStack-SecurityGroupId"
   }
  },
  "ExportsOutputFnGetAttSageMakerExecutionRole7843F3B8ArnECD38BE0": {
   "Value": {
    "Fn::GetAtt": [
     "SageMakerExecutionRole7843F3B8",
     "Arn"
    ]
   },
   "Export": {
    "Name": "RAGSageMakerStudioStack:ExportsOutputFnGetAttSageMakerExecutionRole7843F3B8ArnECD38BE0"
   }
  }
 },
 "Parameters": {
  "BootstrapVersion": {
   "Type": "AWS::SSM::Parameter::Value<String>",
   "Default": "/cdk-bootstrap/hnb659fds/version",
   "Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]"
  }
 },
 "Rules": {
  "CheckBootstrapVersion": {
   "Assertions": [
    {
     "Assert": {
      "Fn::Not": [
       {
        "Fn::Contains": [
         [
          "1",
          "2",
          "3",
          "4",
          "5"
         ],
         {
          "Ref": "BootstrapVersion"
         }
        ]
       }
      ]
     },
     "AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI."
    }
   ]
  }
 }
}